Cloth Simulation for Computer Graphics
=====
[Cem Yuksel](https://dl.acm.org/doi/10.1145/2185520.2185533)


## 6.3 纱线层级松弛
在完成纱线生成后，使用[自适应接触式线性化方法](https://dl.acm.org/doi/10.1145/1778765.1778842)对布料进行松弛处理。

长度约束被替换为每根带有用户自定义静置长度的刚性弹簧。弹簧被视为各向同性，处于静置状态，且不能弯曲。此外，重力被设定为0，并且大量于物体质量成比例的阻尼力被用于使布料松弛。由于初始的几何形状可能存在一些扭曲，为了避免过大的接触集，将接触集定义为相互接触的一对纱线段（纱线通常被建模为由许多小的segments首尾相连组成的rods）。

### 形状保持
#### 边界硬约束
为了维持服装的整体形状，作者使用了[力矩-保持（moment-preserving）](https://dl.acm.org/doi/10.1145/1276377.1276439)约束和力。对边界上的每个纱线环$S_j$，插入一个硬约束，比如：
$$
\mathbf{C}_j=\sum_{i\in{S_j}}\mathbf{q}_i-\sum_{i\in{S_j}}\bar{\mathbf{q}}_i
\tag{5}
$$

- $S_j$ : 边界上的纱线环控制点集合。
- $\mathbf{q}_i$ : $S_j$的第$i$个控制点的位置
- $\bar{\mathbf{q}}_i$ : 控制点初始位置。
- **约束条件**：$\mathbf{C}_j=0$，要求边界环的质心移动为0。

其物理意义是强制布料边界纱线环​（如袖口、下摆）的位置严格匹配初始状态，防止整体形变失真。

#### 内部柔性约束
由于布料内部会存在明显的松弛和移动，对纱线内部结构而言，硬约束条件并不适用。取而代之的是，作者选择每根纱线环作为中心，并选取所有位于stitch mesh上$k$环范围面内的纱线环来定义区块$P_k$。然后根据一项能量项定义了一种各向异性的双向力，其表达方式如下：
$$
E_k^{tracks}=\frac{\kappa_\mathbf{N}(\mathbf{n}_k^T\mathbf{v}_k)(\mathbf{n}_k^T\mathbf{v}_k)^2+\kappa_\mathbf{T}\mathbf{v}_k^T(\mathbf{I}-\mathbf{n}_k\mathbf{n}_k^T)\mathbf{v}_k}{\sum_{S_j\in{P_k}}\sum_{i\in{S_j}}w_j^k}
\tag{6}
$$

$$
\mathbf{v}_k=\sum_{S_j\in{P_k}}\sum_{i\in{S_j}}w_j^k\mathbf{q}_i-\sum_{S_j\in{P_k}}\sum_{i\in{S_j}}w_j^k\bar{\mathbf{q}}_i
\tag{7}
$$

- $P_k$ : 以纱线环为中心的面片（包含$k$-邻域环内的纱线环）
- $\mathbf{n}_k$ : 区块中心面片初始法向量（固定方向）
- $w_j^k$ : 权重函数（随距区块中心拓扑距离衰减）
- $\kappa_\mathbf{N}(\cdot)$ : 在法向/切向的刚度函数，当 $\cdot$ 大于阈值时会变大。
- $\kappa_\mathbf{T}$ : 切向刚度系数。
- $\mathbf{v}_k$ : 面片内所有控制点的加权平均位移。

其物理意义是对内部纱线面片施加各向异性约束，允许切向滑动但抑制法向膨胀，平衡形状保持与局部松弛。

##### 内部约束计算过程拆解
1. **定义面片中心**。首先在stitch mesh中选定一个纱线环（如图3，对应stitch mesh中的一个拓扑单元，也是一个面），记为中心面片$S_{\mathrm{center}}$。
2. **定义区块$P_k$**。代表邻域内所有纱线环控制点的集合，数学定义为$P_k=\{S_j|拓扑距离(S_j,S_\mathrm{center})\leq k\}$。拓扑距离的计算为：$k=0$代表中心面片自身；$k=1$指所有和中心面片共享边的相邻面片；$k=2$指所有和$k=1$面片共享边的相邻面片；以此类推。
3. **计算加权位移量$\mathbf{v}_k$**。$w_j^k$是一个tent函数。
4. **分解位移方向**。法向分量：投影到初始法向量$\mathbf{n}_k$方向上可以获得$法向位移=\mathbf{n}_k^T\mathbf{v}_k$。切向分量：移除法向后的剩余位移，即$切向位移=(\mathbf{I}-\mathbf{n}_k\mathbf{n}_k^T)\mathbf{v}_k$

### 纱线的穿透检测
为了保持布料针织结构始终保持一致，需要防止纱线之间的穿透现象。首先对纱线曲线上的任意点在每一步的最大移动距离设置一个限制值$\tau$，这个限制值是纱线半径的一部分。这样只需要解决每一步开始时已经接触的纱线即可。

作者使用三次Catmull-Rom样条曲线来表征纱线曲线，因此直接求解在某一时间步长内的两条三次曲线交点即可，但这个求解过程很困难。作者通过在两条参数曲线上每隔一定距离放置若干个具有固定参数间隔的球体，并在时间步长区间内检查这些球体的相交情况，只需要解一个二次方程即可。如果发现存在相交，就把缩小球体半径，并重复进行交点测试，直到不相交为止。如果在最精细的包围球级别仍然存在相交，就认为过大的步长导致“穿透”现象，需要减小步长。

然而对于每一时刻每一对相互接触的线段都这样做过于耗费资源，可以通过在每个时间步长结束时为每个控制点计算安全范围来进一步加快这一检测过程，并利用这个范围来避免下一个时间步长内的相交测试。假定在检测穿透时，计算了包围球$\mathbf{f}_{[s_1,s_2]}(t)$和$\mathbf{g}_{[s_3,s_4]}(t)$，其分别界定了在时间步长$t\in[0,1]$内两条样条段上的参数区间$[s_1,s_2]$和$[s_3,s_4]$，并且在该时间步长结束时确定它们没有相交。因此有$d=||\mathbf{f}_{[s_1,s_2]}(1)-\mathbf{g}_{[s_3,s_4]}(1)||_2>0$。这意味着在区间$[s_1,s_2]$和$[s_3,s_4]$内的每一个点都可以最大到$\frac{d}{2}$的移动值而不导致穿透。设$s'$为区间$[s_1,s_2]$上的任意值，$b_i(s)$为样条基函数，$\mathbf{e}_i$（即我们想进行限制的值）为第$i$个控制点在这些范围球相交前允许的最大移动量，由此可以得到：
$$
\left \|\sum_{i=1}^4 b_i(s')\mathbf{e}_i\right\|_2\leq\sum_{i=1}^4|b_i(s')|\left\|\mathbf{e}_i\right\|_2
\tag{8}
$$

将$\frac{d}{2}$的任意划分记为$d_i$（满足$\sum{d_i}=\frac{d}{2}$），那么公式(8)可以简化为：
$$
\left\|\mathbf{e}_i \right\|_2\leq\frac{d_i}{|b_i(s')|}
\tag{9}
$$

虽然最小的分段是$d_i=\frac{d}{8}$，但这样的方式并未考虑到控制点的相对重要性。因此更优的选择是$d_i=\frac{|b_i(s')|d}{\sum|b_i(s')|},\;s'\in[s_1,s_2]$。取最大值来计算整个区间内的界限，可得：
$$
\left\|\mathbf{e}_i\right\|_2\leq\frac{d_i}{\sum(\max_{s'\in[s_1,s_2]}|b_i(s')|)}
\tag{10}
$$

在层级结构中向下移动时，对于所有不接触的球体，取每个控制点的最小允许移动距离，从而可以为每个控制点设定一个允许的移动范围来确保这一对曲线段不会发生穿透。这样在后续步骤中就可以跳过层级下降，从而实现性能提升。

























end